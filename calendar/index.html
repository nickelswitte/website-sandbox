<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8' />

    <!-- CSS -->
    <link href='../lib/fullcalendar/packages/core/main.css' rel='stylesheet' />
    <link href='../lib/fullcalendar/packages/daygrid/main.css' rel='stylesheet' />
    <link href='../lib/fullcalendar/packages/timeGrid/main.css' rel='stylesheet' />
    <link href='../lib/fullcalendar/packages/list/main.css' rel='stylesheet' />

    <!-- JS -->
    <script src='../lib/fullcalendar/packages/core/main.js'></script>
    <script src='../lib/fullcalendar/packages/daygrid/main.js'></script>
    <script src='../lib/fullcalendar/packages/timegrid/main.js'></script>
    <script src='../lib/fullcalendar/packages/list/main.js'></script>

    <script src='../lib/ical.js/ical.min.js'></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="../lib/bootstrap-4.3.1-dist/css/bootstrap.min.css">

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            var calenderDiv = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calenderDiv, {
                // Load the plugins
                plugins: ['dayGrid', 'timeGrid', 'list'],
                // Set area to german
                locale: 'de',
                // Set default view to week
                defaultView: 'timeGridWeek',
                // Determin the header buttons
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay,listWeek'
                },
                // Disable footer
                footer: false,
                // Change button text to german words
                buttonText: {
                    today: 'Heute',
                    month: 'Monat',
                    week: 'Woche',
                    day: 'Tag',
                    list: 'Liste'
                },
                // Change all-day text to german
                allDayText: 'Tag',
                // Determine which hours are highlightes
                businessHours: {
                    // days of week. an array of zero-based day of week integers (0=Sunday)
                    daysOfWeek: [1, 2, 3, 4, 5], // Monday - Thursday

                    startTime: '8:00', // a start time (10am in this example)
                    endTime: '20:00', // an end time (6pm in this example)
                },
                weekends: false,
                // Set the time to display
                minTime: "08:00",
                maxTime: "22:00",
                // Show current time
                nowIndicator: true,
                // Format the time forman in the time axis
                slotLabelFormat: {
                    hour: 'numeric',
                    omitZeroMinute: true,
                    hour12: false,
                },
                // Change how the date in the column header is displayed
                columnHeaderFormat: {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'numeric',
                    omitCommas: true
                },
                // Change how events are displayed
                eventTimeFormat: { // like '14:30:00'
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                eventSources: [
                    {
                        events: [
                            {
                                title: 'Mittag',
                                start: '2019-11-27T12:00:00',
                                end: '2019-11-27T12:45:00'
                            },
                            {
                                title: 'All Day Event',
                                start: '2019-11-28'
                            }
                        ],
                        color: 'green',
                        textColor: 'white'

                    }
                ]
            });

            calendar.render();
        });


        // Test to parse ical data

        var iCalendarData = [
            'BEGIN:VCALENDAR',
            'CALSCALE:GREGORIAN',
            'PRODID:-//Example Inc.//Example Calendar//EN',
            'VERSION:2.0',
            'BEGIN:VEVENT',
            'DTSTAMP:20080205T191224Z',
            'DTSTART:20081006',
            'SUMMARY:Planning meeting',
            'UID:4088E990AD89CB3DBB484909',
            'END:VEVENT',
            'END:VCALENDAR'
        ].join("\r\n");


        var jcalData = ICAL.parse(iCalendarData);
        var vcalendar = new ICAL.Component(jcalData);
        var vevent = vcalendar.getFirstSubcomponent('vevent');
        var summary = vevent.getFirstPropertyValue('summary');
        console.log('Summary: ' + summary);


        // Test to xmlhttprequest ical file and parse

        var data;

        // Load thing
        function loadScript(callbackMethod, pathToFile) {   

            // console.log(callbackMethod + " " + pathToFile);

            var xobj = new XMLHttpRequest();

            xobj.overrideMimeType("text/plain");

            xobj.open('GET', pathToFile, true);

            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    //eval(xobj.responseText);
                    console.log(xobj.responseText);
                    data = xobj.responseText;
                    callbackMethod();
                }
            };

            xobj.send(null);  
        }

        // Parse it
        function callback() {
            console.log("Called!");
            var jcalData = ICAL.parse(data);
            var vcalendar = new ICAL.Component(jcalData);
            var vevent = vcalendar.getFirstSubcomponent('vevent');
            var summary = vevent.getFirstPropertyValue('summary');
            console.log('Summary: ' + summary);
        }

        // Call ical file
        loadScript(callback, './ics/file.ics');

        // http://193.196.6.13/rapla?page=ical&user=Schmidt&file=TIM17%2BTIT17

        // Do proxy call
        function proxyCall(callbackMethod) {   

            console.log('Proxy call started.');

            var pathToFile = '../lib/php-cross-domain-proxy-master/proxy.php';
            // var pathToFile = '../lib/php-cross-domain-proxy/hi.php';
            // var pathToFile = '../lib/php-cross-domain-proxy/file.ics';

            // console.log(callbackMethod + " " + pathToFile);

            var xobj = new XMLHttpRequest();

            // xobj.overrideMimeType("text/plain");

            xobj.open('GET', pathToFile, true);

            /*
            xobj.setRequestHeader('csurl', "http://193.196.6.13/rapla");
            xobj.setRequestHeader('page', 'ical');
            xobj.setRequestHeader('user', 'Schmidt');
            xobj.setRequestHeader('file', 'TIM17%2BTIT17');
            */

            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    //eval(xobj.responseText);
                    console.log('SUCCESS!!!');
                    console.log(xobj.responseText);
                    callbackMethod();
                } else {
                    console.log('An Error has occured');
                    console.log('Status: ' + xobj.statusText);
                }
            };

            xobj.send(null);  
        }

        // Execute call
        proxyCall(callback2);

        function callback2() {
            console.log("Callback reached");
        }
        

    </script>
</head>

<body>

    <div class="container">
        <div id='calendar'></div>
    </div>

    <style>
        #calendar {
            /*max-width: 1200px;*/
            max-height: 100%;
            margin: 0 auto;
            margin-top: 10px;
        }
    </style>


</body>

</html>